generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // Optimize for Neon free tier
  // Use connection pooling URL (ends with -pooler) for better performance
  // Direct connection URL (without -pooler) for migrations
}

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  username          String    @unique
  password          String?
  fullName          String    @map("full_name")
  displayName       String?   @map("display_name") // Anonymous name shown to others
  avatarUrl         String?   @map("avatar_url")
  timezone          String    @default("UTC")
  availabilityHours Json      @map("availability_hours")
  goalType          GoalType? @map("goal_type")
  goalDescription   String?   @map("goal_description")
  goalCategory      String?   @map("goal_category")
  gender            String?   // Added gender field
  currentStreak     Int       @default(0) @map("current_streak")
  lastCheckIn       DateTime? @map("last_check_in")
  lastSuccessfulDay DateTime? @map("last_successful_day") // Last day user completed successfully
  restoresUsedThisMonth Int   @default(0) @map("restores_used_this_month")
  restoresResetAt   DateTime  @default(now()) @map("restores_reset_at") // Track when restores were last reset
  isDemoAccount     Boolean   @default(false) @map("is_demo_account")
  onboardingComplete Boolean  @default(false) @map("onboarding_complete")
  podId             String?   @map("pod_id")
  availabilityMessage String? @map("availability_message")
  isAI              Boolean   @default(false) @map("is_ai")
  
  pod               Pod?               @relation(fields: [podId], references: [id])
  crisisAlerts      CrisisAlert[]
  messages          PodMessage[]
  checkIns          CheckIn[]
  streakRestores    StreakRestore[]
  toolkitItems      CrisisToolkitItem[]
  achievements      Achievement[]
  
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  @@map("users")
}

model Pod {
  id           String    @id @default(uuid())
  name         String
  totalStreak  Int       @default(0) @map("total_streak")
  podType      PodType   @default(REAL) @map("pod_type")
  goalType     GoalType? @map("goal_type") // Match users with same mindset (quit or build)
  goalCategory String?   @map("goal_category")
  lastShownMessageUserId String? @map("last_shown_message_user_id")
  
  members      User[]
  messages     PodMessage[]
  crisisAlerts CrisisAlert[]
  achievements Achievement[]
  
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  @@map("pods")
}

model CrisisAlert {
  id            String        @id @default(uuid())
  userId        String        @map("user_id")
  podId         String        @map("pod_id")
  message       String?
  status        AlertStatus   @default(ACTIVE)
  responseCount Int           @default(0) @map("response_count")
  lastShownMessageUserId String? @map("last_shown_message_user_id")
  aiResponses   Json?         @map("ai_responses")
  
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  pod           Pod           @relation(fields: [podId], references: [id], onDelete: Cascade)
  responses     PodMessage[]
  
  createdAt     DateTime      @default(now()) @map("created_at")
  resolvedAt    DateTime?     @map("resolved_at")

  @@map("crisis_alerts")
}

model PodMessage {
  id               String       @id @default(uuid())
  podId            String       @map("pod_id")
  userId           String       @map("user_id")
  messageText      String       @map("message_text")
  imageUrl         String?      @map("image_url")
  isCrisisResponse Boolean      @default(false) @map("is_crisis_response")
  alertId          String?      @map("alert_id")
  isDeleted        Boolean      @default(false) @map("is_deleted")
  deletedReason    String?      @map("deleted_reason")
  
  pod              Pod          @relation(fields: [podId], references: [id], onDelete: Cascade)
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  alert            CrisisAlert? @relation(fields: [alertId], references: [id], onDelete: SetNull)
  reactions        MessageReaction[]
  reports          MessageReport[]
  
  createdAt        DateTime     @default(now()) @map("created_at")

  @@map("pod_messages")
}

model MessageReaction {
  id         String     @id @default(uuid())
  messageId  String     @map("message_id")
  userId     String     @map("user_id")
  emoji      String
  
  message    PodMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  
  createdAt  DateTime   @default(now()) @map("created_at")

  @@unique([messageId, userId, emoji])
  @@map("message_reactions")
}

model MessageReport {
  id         String     @id @default(uuid())
  messageId  String     @map("message_id")
  reportedBy String     @map("reported_by")
  reason     String?
  status     ReportStatus @default(PENDING)
  
  message    PodMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  
  createdAt  DateTime   @default(now()) @map("created_at")

  @@unique([messageId, reportedBy])
  @@map("message_reports")
}

model CheckIn {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  stayedOnTrack  Boolean  @map("stayed_on_track")
  date           DateTime @default(now())
  
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt      DateTime @default(now()) @map("created_at")

  @@unique([userId, date])
  @@map("check_ins")
}

model StreakRestore {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  restoredDate  DateTime @map("restored_date") // The date that was restored
  streakAtRestore Int    @map("streak_at_restore") // Streak value when restore was used
  month         Int      // Month when restore was used (1-12)
  year          Int      // Year when restore was used
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("streak_restores")
}

model CrisisToolkitItem {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  title         String
  description   String
  orderPosition Int      @map("order_position")
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("crisis_toolkit_items")
}

model Achievement {
  id        String          @id @default(uuid())
  podId     String?         @map("pod_id")
  userId    String?         @map("user_id")
  badgeType BadgeType       @map("badge_type")
  
  pod       Pod?            @relation(fields: [podId], references: [id], onDelete: Cascade)
  user      User?           @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  earnedAt  DateTime        @default(now()) @map("earned_at")

  @@map("achievements")
}

enum GoalType {
  QUIT_HABIT
  BUILD_HABIT
}

enum AlertStatus {
  ACTIVE
  RESOLVED
}

enum BadgeType {
  SEVEN_DAY_STREAK
  THIRTY_DAY_STREAK
  INSTANT_RESPONDER
  POD_CHAMPION
}

enum PodType {
  REAL
  AI
}

enum ReportStatus {
  PENDING
  REVIEWED
  ACTION_TAKEN
  DISMISSED
}
